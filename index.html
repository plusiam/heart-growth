<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>쑥쑥! 마음 성장 노트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: 'Pretendard', sans-serif; }
        .font-gowun { font-family: 'Gowun Dodum', sans-serif; }
    </style>
</head>
<body class="bg-emerald-50 flex items-center justify-center min-h-screen p-4 md:p-8">

    <div class="w-full max-w-3xl bg-white rounded-xl shadow-lg p-6 md:p-10 space-y-6">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">쑥쑥! 마음 성장 노트 🌱</h1>
            <p class="text-gray-500 mt-2">내 마음을 돌아보며 생각하는 힘을 기르는 시간이에요.</p>
        </div>

        <form id="reflectionForm" onsubmit="return false;">
            <div class="mt-8">
                <h2 class="text-2xl font-semibold text-gray-700 border-b-2 border-gray-200 pb-2">속상했던 그날 ✏️</h2>
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="positive_memory" class="block text-md font-medium text-gray-700 mb-2">① 친구랑 좋았을 때! 😊</label>
                        <textarea id="positive_memory" name="positive_memory" rows="3" class="w-full p-3 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 transition" placeholder="친구가 나에게 잘해줬던 일, 같이 웃었던 일, 고마웠던 일을 떠올려봐요."></textarea>
                    </div>
                    <div>
                        <label for="activating_event" class="block text-md font-medium text-gray-700 mb-2">② 무슨 일이 있었냐면...</label>
                        <textarea id="activating_event" name="activating_event" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 transition" placeholder="누가, 언제, 어디서, 무엇을 했는지 있었던 일만 그대로 적어봐요. (예: 어제 쉬는 시간에 철수가 나를 못 보고 지나갔다.)"></textarea>
                    </div>
                </div>
            </div>
            <div class="mt-8">
                <h2 class="text-2xl font-semibold text-gray-700 border-b-2 border-gray-200 pb-2">나도 모르게 든 생각 💭</h2>
                <div class="mt-4">
                    <label for="belief" class="block text-md font-medium text-gray-700 mb-2">③ 그때 내 마음속에 떠오른 생각</label>
                    <textarea id="belief" name="belief" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 transition" placeholder="'혹시 나를 싫어하나?', '나만 빼고 노는 건가?' 처럼 마음속에 번개처럼 스쳐 지나간 생각을 솔직하게 적어봐요."></textarea>
                </div>
            </div>
            <div class="mt-8">
                <h2 class="text-2xl font-semibold text-gray-700 border-b-2 border-gray-200 pb-2">그래서 내 기분은... 내 행동은... 😢</h2>
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="emotion" class="block text-md font-medium text-gray-700 mb-2">④ 내 마음 날씨는 어땠어?</label>
                        <textarea id="emotion" name="emotion" rows="3" class="w-full p-3 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 transition" placeholder="마음이 어땠는지 알려줘요. (예: 속상했다, 화가 났다, 눈물이 날 것 같았다, 심장이 쿵쾅거렸다.)"></textarea>
                    </div>
                    <div>
                        <label for="behavior" class="block text-md font-medium text-gray-700 mb-2">⑤ 그래서 나는 어떻게 했어?</label>
                        <textarea id="behavior" name="behavior" rows="3" class="w-full p-3 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 transition" placeholder="친구한테 쌀쌀맞게 말했나요? 아니면 그냥 휙 돌아서 버렸나요? 내가 했던 말이나 행동을 적어봐요."></textarea>
                    </div>
                </div>
            </div>
            <div class="mt-8">
                <h2 class="text-2xl font-semibold text-emerald-700 border-b-2 border-emerald-200 pb-2">생각 스트레칭! 🤸</h2>
                 <div class="mt-4 space-y-4">
                    <div>
                        <label for="dispute" class="block text-md font-medium text-gray-700 mb-2">⑥ 정말 그럴까? (생각 흔들기)</label>
                        <textarea id="dispute" name="dispute" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 transition" placeholder="내 생각이 100% 맞을까? 아닐 수도 있지 않을까? 여러 가지 가능성을 상상해봐요. (예: 나를 못 봤을 수도 있어. 급한 일이 있었나봐.)"></textarea>
                    </div>
                    <div>
                        <label for="rational_belief" class="block text-md font-medium text-gray-700 mb-2">⑦ 마음이 편해지는 새로운 생각!</label>
                        <textarea id="rational_belief" name="rational_belief" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 transition" placeholder="기분이 좋아지는 새로운 생각을 찾아봐요! (예: '무슨 일이 있었는지 다음에 물어봐야지!', '내가 오해했을 수도 있겠다.')"></textarea>
                    </div>
                </div>
            </div>
            <div class="mt-8">
                <h2 class="text-2xl font-semibold text-emerald-700 border-b-2 border-emerald-200 pb-2">마음도 튼튼, 관계도 튼튼! 🌱</h2>
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="new_emotion" class="block text-md font-medium text-gray-700 mb-2">⑧ 새로운 생각을 하니 마음이 어때?</label>
                        <textarea id="new_emotion" name="new_emotion" rows="3" class="w-full p-3 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 transition" placeholder="화났던 마음이 조금 가라앉았나요? 궁금한 마음이 생겼나요? 솔직한 마음을 알려줘요."></textarea>
                    </div>
                    <div>
                        <label for="new_action" class="block text-md font-medium text-gray-700 mb-2">⑨ 앞으로 이렇게 해야지! (나의 약속)</label>
                        <textarea id="new_action" name="new_action" rows="3" class="w-full p-3 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 transition" placeholder="다음에는 친구에게 어떻게 말하고 행동하고 싶나요? 용기 있는 나의 약속을 적어봐요. (예: 먼저 다가가서 '무슨 일 있었어?' 하고 물어볼래.)"></textarea>
                    </div>
                </div>
            </div>

            <div class="mt-10 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4">
                <button type="button" id="resetBtn" class="w-full sm:w-auto px-6 py-2.5 bg-gray-300 text-gray-800 font-semibold rounded-md hover:bg-gray-400 transition">처음부터 다시!</button>
                <button type="button" id="downloadCsvBtn" class="w-full sm:w-auto px-6 py-2.5 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 transition">내용 저장(CSV)</button>
                <button type="button" id="downloadPdfBtn" class="w-full sm:w-auto px-6 py-2.5 bg-emerald-500 text-white font-semibold rounded-md hover:bg-emerald-600 transition">마음 성장 노트 PDF 저장</button>
            </div>
        </form>
    </div>

    <div id="pdfCard" class="font-gowun" style="position: absolute; left: -9999px; width: 794px; min-height: 1123px; padding: 60px; background-image: linear-gradient(to bottom right, #f0fdf4, #ecfdf5);">
        <div class="text-center mb-12 border-b-4 border-emerald-300 pb-6">
            <h1 class="text-5xl font-bold text-emerald-800">쑥쑥! 마음 성장 노트</h1>
        </div>
        <div class="space-y-6 text-slate-700">
            <div class="p-5 bg-white/70 rounded-lg shadow-sm">
                <h3 class="text-2xl font-semibold text-emerald-700 mb-2">친구와 함께한 반짝이는 순간 ✨</h3>
                <p id="pdf_positive_memory" class="text-xl leading-relaxed whitespace-pre-wrap"></p>
            </div>
            <div class="p-5 bg-white/70 rounded-lg shadow-sm">
                <h3 class="text-2xl font-semibold text-emerald-700 mb-2">마음이 쿵! 했던 그 일 🌩️</h3>
                <p id="pdf_activating_event" class="text-xl leading-relaxed whitespace-pre-wrap"></p>
            </div>
            <div class="p-5 bg-white/70 rounded-lg shadow-sm">
                <h3 class="text-2xl font-semibold text-emerald-700 mb-2">내 머릿속 생각과 마음 날씨 💭</h3>
                <p id="pdf_belief" class="text-xl leading-relaxed whitespace-pre-wrap"></p>
                <p id="pdf_emotion" class="mt-3 text-xl leading-relaxed whitespace-pre-wrap font-semibold text-red-500"></p>
            </div>
            <div class="p-5 bg-white/70 rounded-lg shadow-sm">
                <h3 class="text-2xl font-semibold text-emerald-700 mb-2">생각 스트레칭으로 찾은 새로운 생각 🤸</h3>
                <p id="pdf_rational_belief" class="text-xl leading-relaxed whitespace-pre-wrap font-semibold text-green-700"></p>
            </div>
             <div class="p-5 bg-white/70 rounded-lg shadow-sm">
                <h3 class="text-2xl font-semibold text-emerald-700 mb-2">나의 용기있는 약속 🌱</h3>
                <p id="pdf_new_action" class="text-xl leading-relaxed whitespace-pre-wrap"></p>
            </div>
        </div>
        <div class="mt-16 text-center text-gray-500">
            <p class="text-lg">오늘 너의 마음은 한 뼘 더 자랐어!</p>
            <p id="pdf_date" class="mt-2 text-md"></p>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        const form = document.getElementById('reflectionForm');
        const resetBtn = document.getElementById('resetBtn');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    
        window.onload = function() {
            downloadPdfBtn.innerHTML = '마음 성장 노트 PDF 저장';
            downloadPdfBtn.disabled = false;
        };
    
        downloadPdfBtn.innerHTML = '준비 중...';
        downloadPdfBtn.disabled = true;
    
        function getFormData() {
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            return data;
        }
    
        resetBtn.addEventListener('click', () => form.reset());
    
        downloadCsvBtn.addEventListener('click', () => {
            const labelMapping = {
                'positive_memory': '① 친구랑 좋았을 때!', 'activating_event': '② 무슨 일이 있었냐면...', 'belief': '③ 그때 내 마음속에 떠오른 생각', 'emotion': '④ 내 마음 날씨는 어땠어?', 'behavior': '⑤ 그래서 나는 어떻게 했어?', 'dispute': '⑥ 정말 그럴까? (생각 흔들기)', 'rational_belief': '⑦ 마음이 편해지는 새로운 생각!', 'new_emotion': '⑧ 새로운 생각을 하니 마음이 어때?', 'new_action': '⑨ 앞으로 이렇게 해야지! (나의 약속)'
            };
            const data = getFormData();
            const headers = ['항목', '내용'];
            const rows = Object.entries(data).map(([key, value]) => {
                const label = labelMapping[key] || key;
                const sanitizedValue = value.replace(/"/g, '""');
                return `"${label}","${sanitizedValue}"`;
            });
            const bom = '\uFEFF';
            const csvContent = bom + headers.join(',') + '\n' + rows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'heart_growth_log.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    
        downloadPdfBtn.addEventListener('click', async () => {
            const originalButtonText = downloadPdfBtn.innerHTML;
            downloadPdfBtn.innerHTML = '만드는 중...';
            downloadPdfBtn.disabled = true;
    
            const data = getFormData();
            
            document.getElementById('pdf_positive_memory').innerText = data.positive_memory || ' ';
            document.getElementById('pdf_activating_event').innerText = data.activating_event || ' ';
            document.getElementById('pdf_belief').innerText = data.belief || ' ';
            document.getElementById('pdf_emotion').innerText = data.emotion || ' ';
            document.getElementById('pdf_rational_belief').innerText = data.rational_belief || ' ';
            document.getElementById('pdf_new_action').innerText = data.new_action || ' ';
            document.getElementById('pdf_date').innerText = new Date().toLocaleDateString('ko-KR');
            
            await new Promise(resolve => setTimeout(resolve, 100));

            const pdfCard = document.getElementById('pdfCard');
            const canvas = await html2canvas(pdfCard, {
                scale: 2,
                useCORS: true
            });
            
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 210;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            
            const doc = new jsPDF('p', 'mm', 'a4');
            doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            doc.save('my_heart_growth_note.pdf');
    
            downloadPdfBtn.innerHTML = originalButtonText;
            downloadPdfBtn.disabled = false;
        });
    </script>    
</body>
</html>